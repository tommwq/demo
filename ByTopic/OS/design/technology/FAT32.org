#+title: FAT32结构

* FAT32结构

FAT32是一个简单的磁盘文件系统。在FAT32中，数据以扇区（512字节）为单位。FAT32将文件系统分为3部分：启动记录、文件分配表和数据区域。FAT32采用小端。

* 启动记录


磁盘的第一个扇区是启动记录，也叫做主启动记录（MBR，Master Boot Record）。MBR开头的部分是BPB（BIOS Parameter Block）。BPB占36字节，格式如下：

| 偏移量 | 长度 | 说明                        |
|      0 |    3 | 跳转语句，一般为 EB 3C 90。 |
|      3 |    8 | OEM名字。                   |
|     11 |    2 | 扇区大小（字节）。          |
|     13 |    1 | 柱面大小（扇区数）。        |
|     14 |    2 | 保留的扇区数。              |
|     16 |    1 | FAT表数量。                 |
|     17 |    2 | 根目录条目数。              |
|     19 |    2 | 扇区总数。                  |
|     21 |    1 | Media descriptor type。     |
|     22 |    2 | 每个FAT的扇区数。           |
|     24 |    2 | 每个磁道track的扇区数。     |
|     26 |    2 | 磁头head数。                |
|     28 |    4 | 隐藏的扇区数。              |
|     32 |    4 | 文件系统总扇区数。          |

常用的Media descriptor type有
| 类型 | 说明           |
| F0   | 1.44MB软盘。   |
| F8   | 固定大小磁盘。 |


BPB后面是扩展启动记录（Extend Boot Record）。FAT32的扩展启动记录结构为

| 偏移量 | 长度 | 说明                                |
|     36 |    4 | FAT大小（扇区数）。                 |
|     40 |    2 | 标志。                              |
|     42 |    2 | FAT版本号。                         |
|     44 |    4 | 根目录的cluster号。                 |
|     48 |    2 | FSInfo扇区号。                      |
|     50 |    2 | 备份启动扇区号。                    |
|     52 |   12 | 保留。                              |
|     64 |    1 | 驱动器号。0表示软盘，0x80表示硬盘。 |
|     65 |    1 | 保留。                              |
|     66 |    1 | 签名，必须是0x28或0x29。            |
|     67 |    4 | 卷序列号。                          |
|     71 |   11 | 卷标签，以空格填充。                |
|     82 |    8 | 字符串"FAT32   "。                  |
|     90 |  420 | 启动代码。                          |
|    510 |    2 | 0xaa55。                            |



* 文件分配表（FAT，File Allocation Table）

FAT32用28个位来定位磁盘簇。


* 数据区域


* 参考
https://wiki.osdev.org/FAT#FAT_32
